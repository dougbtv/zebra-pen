---

- name: Template quagga config
  template: 
    src: Quagga.conf.j2
    dest: "{{ destination_config }}"

- name: Template quagga config
  template: 
    src: daemons.j2
    dest: /etc/quagga.daemons

- name: List docker images
  shell: >
    docker images
  register: docker_images

- name: Pull quagga when not found
  shell: >
    docker pull cumulusnetworks/quagga:xenial-latest
  when: "'cumulusnetworks/quagga' not in '{{ docker_images.stdout }}'"

- name: Always setup iptables forwarding rules
  shell: >
    iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE &&
    iptables -A FORWARD -i eth0 -j ACCEPT

- name: Kill and remove quagga, conditionally
  shell: >
    docker kill {{ quagga_container_name }}
  when: "{{force_quagga_kill}}"
  ignore_errors: yes

- name: Get list of running containers
  shell: >
    docker ps -a
  register: docker_psa

- name: Default volume fact
  set_fact:
    config_mount: ""

- name: Set volume fact when necessary
  set_fact:
    config_mount: "-v {{ use_config }}:/etc/quagga/Quagga.conf"
  when: use_config is defined

- name: Run quagga if not yet running
  # 
  shell: >
    docker run -dt 
    --name {{ quagga_container_name }} 
    -h {{ quagga_container_name }} 
    {{ config_mount }} 
    -v /etc/quagga.daemons:/etc/quagga/daemons
    --rm 
    --privileged 
    cumulusnetworks/quagga:xenial-latest
  when: "'{{ quagga_container_name }}' not in '{{ docker_psa.stdout }}'"

# Quagga has some problems here, they're not using a single process in the foreground
# So we have to baby starting it up
# So let's list the processes in the container and start up quagga if need be

- name: Install packages when debug is enabled
  shell: >
    docker exec -i {{ quagga_container_name }} /bin/bash -c 'apt-get update && apt-get -y install inetutils-ping net-tools tcpdump'
  when: quagga_debug is defined

- name: List processes in container
  shell: >
    docker exec -i {{ quagga_container_name }} ps ax
  register: quagga_ps

- name: Run quagga in the container via exec
  shell: >
    docker exec -i {{ quagga_container_name }} /usr/lib/quagga/quagga start
  when: "'zebra' not in '{{ quagga_ps.stdout }}'"